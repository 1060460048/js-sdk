function QiniuJsSDK(a){var b={trim:function(a){return null===a?"":this.trim.call(a)},parseJSON:function(a){return window.JSON&&window.JSON.parse?window.JSON.parse(a):null===a?a:"string"==typeof a&&(a=this.trim(a),a&&/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))?function(){return a}():void 0},createAjax:function(){var a={};return a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},URLSafeBase64Encode:function(a){return a=mOxie.btoa(a),a.replace(/\//g,"_").replace(/\+/g,"-")}},c=this;if(!a.domain)throw"uptoken_url or domain is required!";if(!a.browse_button)throw"browse_button is required!";var d={};c.uptoken_url=a.uptoken_url,c.token="",c.key_handler="function"==typeof a.init.Key?a.init.Key:"",this.domain=a.domain;var e="",f=function(){if(a.up_host)return a.up_host;var b=window.location.protocol;return"https"!==b?"http://up.qiniu.com":"https://up.qbox.me"},g=f(),h=function(){var b,c,d,e="IE"===mOxie.Env.browser&&mOxie.Env.version<=9;e&&a.chunk_size&&a.runtimes.indexOf("flash")>=0?a.chunk_size=0:(b=20,c=4<<b,d=plupload.parseSize(a.chunk_size),d>c&&(a.chunk_size=c))};h();var i=function(){if(a.uptoken)c.token=a.uptoken;else{var d=b.createAjax();d.open("GET",c.uptoken_url,!0),d.setRequestHeader("If-Modified-Since","0"),d.onreadystatechange=function(){if(4===d.readyState&&200===d.status){var a=b.parseJSON(d.responseText);c.token=a.uptoken}},d.send()}},j=function(a,b){var c=a.getOption&&a.getOption(b);return c=c||a.settings&&a.settings[b]},k=function(b,c,d){var e="",f=!1;if(!a.save_key)if(f=j(b,"unique_names")){var g=mOxie.Mime.getFileExtension(c.name);e=g?c.id+"."+g:c.id}else e="function"==typeof d?d(b,c):c.name;return e};plupload.extend(d,a,{url:g,multipart_params:{token:""}});var l=new plupload.Uploader(d);return l.bind("Init",function(){i()}),l.init(),l.bind("FilesAdded",function(a,b){var c=j(a,"auto_start");c&&$.each(b,function(){a.start()}),a.refresh()}),l.bind("BeforeUpload",function(b,d){e="";var f=function(b,d,e){var f;f=a.save_key?{token:c.token}:{key:k(b,d,e),token:c.token};var h=a.x_vars;if(void 0!==h&&"object"==typeof h)for(var i in h)h.hasOwnProperty(i)&&("function"==typeof h[i]?f["x:"+i]=h[i](b,d):"object"!=typeof h[i]&&(f["x:"+i]=h[i]));b.setOption({url:g,multipart:!0,chunk_size:void 0,multipart_params:f})},h=function(a,b){var d=localStorage.getItem(b.name),f=i;if(d){d=JSON.parse(d);var h=(new Date).getTime(),j=d.time||0,k=864e5;k>h-j&&100!==d.percent?(b.percent=d.percent,b.loaded=d.offset,e=d.ctx,d.offset+f>b.size&&(f=b.size-d.offset)):localStorage.removeItem(b.name)}a.setOption({url:g+"/mkblk/"+f,multipart:!1,chunk_size:i,required_features:"chunks",headers:{Authorization:"UpToken "+c.token},multipart_params:{}})},i=j(b,"chunk_size");"html5"===l.runtime&&i?d.size<i?f(b,d,c.key_handler):h(b,d):f(b,d,c.key_handler)}),l.bind("ChunkUploaded",function(a,c,d){var f=function(a){localStorage.setItem(a.name,JSON.stringify({ctx:e,percent:a.percent,total:d.total,offset:d.offset,time:(new Date).getTime()}))},h=b.parseJSON(d.response);e=e?e+","+h.ctx:h.ctx;var i=d.total-d.offset,k=j(a,"chunk_size");k>i&&a.setOption({url:g+"/mkblk/"+i}),f(c)}),l.bind("Error",function(a,c){var d="",e=c.file;if(e){switch(c.code){case plupload.FAILED:d="上传失败。请稍后再试。";break;case plupload.FILE_SIZE_ERROR:var f=j(a,"max_file_size");d="浏览器最大可上传"+f+"。更大文件请使用命令行工具。";break;case plupload.FILE_EXTENSION_ERROR:d="文件验证失败。请稍后重试。";break;case plupload.HTTP_ERROR:var g=b.parseJSON(c.response),h=g.error;switch(c.status){case 400:d="请求报文格式错误。";break;case 401:d="客户端认证授权失败。请重试或提交反馈。";break;case 405:d="客户端请求错误。请重试或提交反馈。";break;case 579:d="资源上传成功，但回调失败。";break;case 599:d="网络连接异常。请重试或提交反馈。";break;case 614:d="文件已存在。";try{g=b.parseJSON(g.error),h=g.error||"file exists"}catch(i){h=g.error||"file exists"}break;case 631:d="指定空间不存在。";break;case 701:d="上传数据块校验出错。请重试或提交反馈。";break;default:d="未知错误。"}d=d+"("+c.status+"："+h+")";break;case plupload.SECURITY_ERROR:d="安全配置错误。请联系网站管理员。";break;case plupload.GENERIC_ERROR:d="上传失败。请稍后再试。";break;case plupload.IO_ERROR:d="上传失败。请稍后再试。";break;case plupload.INIT_ERROR:d="网站配置错误。请联系网站管理员。",l.destroy();break;default:d=c.message+c.details}a.setOption("error",d)}a.refresh()}),l.bind("FileUploaded",function(d,f,h){var i=function(c){var h="";a.save_key||(h=k(d,f,c.key_handler),h=h?"/key/"+b.URLSafeBase64Encode(h):"");var i=j(),n=g+"/mkfile/"+f.size+h+i,o=b.createAjax();o.open("POST",n,!0),o.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),o.setRequestHeader("Authorization","UpToken "+c.token),o.onreadystatechange=function(){if(4===o.readyState)if(localStorage.removeItem(f.name),200===o.status){var a=o.responseText;m(c,a)}else l.trigger("Error",{status:o.status,response:o.responseText,file:f,code:-200})},o.send(e)},j=function(){var c=a.x_vars,e="",g="";if(void 0!==c&&"object"==typeof c)for(var h in c)c.hasOwnProperty(h)&&("function"==typeof c[h]?e=b.URLSafeBase64Encode(c[h](d,f)):"object"!=typeof c[h]&&(e=b.URLSafeBase64Encode(c[h])),g+="/x:"+h+"/"+e);return g},m=function(c,e){if(a.downtoken_url){var g=b.parseJSON(e),h=b.createAjax();h.open("POST",a.downtoken_url,!1),h.setRequestHeader("Content-type","application/x-www-form-urlencoded"),h.onreadystatechange=function(){if(4===h.readyState)if(200===h.status){var a;try{a=b.parseJSON(h.responseText)}catch(c){throw"invalid json format"}plupload.extend(g,a),e=JSON.stringify(g),console.log(e),d.setOption("info",e)}else l.trigger("Error",{status:h.status,response:h.responseText,file:f,code:plupload.HTTP_ERROR})},h.send("key="+g.key+"&domain="+a.domain)}},n=b.parseJSON(h.response);e=e?e:n.ctx,e?i(c):m(c,h.response)}),this.getUrl=function(a){if(!a)return!1;a=encodeURI(a);var b=this.domain;return"/"!==b.slice(b.length-1)&&(b+="/"),b+a},l}